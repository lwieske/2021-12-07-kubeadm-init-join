---
marp: true
---

<!-- _class: invert -->

## Flatcar - Kubernetes

* In the first demo a single instance will be set up as a controller node via kubeadm.

* One thing not obvious in the last demo is a bug in the setup of kubelet in Flatcar.

* Kubelet finally exits as it cannot read the config file */var/lib/kubelet/config.yaml*.

---

## Kubeadm Init

* Kubeadm does many things. And *kubeadm init* is not different.

* It configures the kubelet and writes the missing config file.

```
sudo kubeadm init \
  --upload-certs
```

---

## Kubeadm Init - Init + Preflight

```
...
[init] Using Kubernetes version: v1.22.4...
[preflight] Running pre-flight checks...
[preflight] Pulling images required for setting up a Kubernetes cluster...
[preflight] This might take a minute or two, depending on the speed of your i...
[preflight] You can also perform this action in beforehand using 'kubeadm con...
...
```

---

## Kubeadm Init - Etcd

```
...
[certs] Using certificateDir folder "/etc/kubernetes/pki"...
[certs] Generating "ca" certificate and key...
[certs] Generating "apiserver" certificate and key...
[certs] apiserver serving cert is signed for DNS names [ip-10-0-1-177.eu-cent...
[certs] Generating "apiserver-kubelet-client" certificate and key...
[certs] Generating "front-proxy-ca" certificate and key...
[certs] Generating "front-proxy-client" certificate and key...
[certs] Generating "etcd/ca" certificate and key...
[certs] Generating "etcd/server" certificate and key...
[certs] etcd/server serving cert is signed for DNS names [ip-10-0-1-177.eu-ce...
[certs] Generating "etcd/peer" certificate and key...
[certs] etcd/peer serving cert is signed for DNS names [ip-10-0-1-177.eu-cent...
[certs] Generating "etcd/healthcheck-client" certificate and key...
[certs] Generating "apiserver-etcd-client" certificate and key...
[certs] Generating "sa" key and public key...
...
```

---

## Kubeadm Init - Kubeconfig + Kubelet-Start

```
...
[kubeconfig] Using kubeconfig folder "/etc/kubernetes"...
[kubeconfig] Writing "admin.conf" kubeconfig file...
[kubeconfig] Writing "kubelet.conf" kubeconfig file...
[kubeconfig] Writing "controller-manager.conf" kubeconfig file...
[kubeconfig] Writing "scheduler.conf" kubeconfig file...
[kubelet-start] Writing kubelet environment file with flags to file "/var/lib...
[kubelet-start] Writing kubelet configuration to file "/var/lib/kubelet/confi...
[kubelet-start] Starting the kubelet...
...
```

---

## Kubeadm Init - Control-plane + Etcd

```
...
[control-plane] Using manifest folder "/etc/kubernetes/manifests"...
[control-plane] Creating static Pod manifest for "kube-apiserver"...
[control-plane] Creating static Pod manifest for "kube-controller-manager"...
[control-plane] Creating static Pod manifest for "kube-scheduler"...
[etcd] Creating static Pod manifest for local etcd in "/etc/kubernetes/manife...
[wait-control-plane] Waiting for the kubelet to boot up the control plane as ...
[apiclient] All control plane components are healthy after 20.504357 seconds...
...
```

---

## Kubeadm Init - Upload + Mark

```
...
[upload-config] Storing the configuration used in ConfigMap "kubeadm-config" ...
[kubelet] Creating a ConfigMap "kubelet-config-1.22" in namespace kube-system...
[upload-certs] Storing the certificates in Secret "kubeadm-certs" in the "kub...
[upload-certs] Using certificate key:...
02c2aa83b508420919ef41b7327020d2354c527656515705a79b92cce66f14a8...
[mark-control-plane] Marking the node ip-10-0-1-177.eu-central-1.compute.inte...
[mark-control-plane] Marking the node ip-10-0-1-177.eu-central-1.compute.inte...
...
```

---

## Kubeadm Init - Bootstrap-Token

```
...
[bootstrap-token] Using token: k73i8b.f1mzwk2bh75o7o4x...
[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC ...
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to get...
[bootstrap-token] configured RBAC rules to allow Node Bootstrap tokens to pos...
[bootstrap-token] configured RBAC rules to allow the csrapprover controller a...
[bootstrap-token] configured RBAC rules to allow certificate rotation for all...
[bootstrap-token] Creating the "cluster-info" ConfigMap in the "kube-public" ...
[kubelet-finalize] Updating "/etc/kubernetes/kubelet.conf" to point to a rota...
...
```

---

## Kubeadm Init - Addons

```
...
[addons] Applied essential addon: CoreDNS...
[addons] Applied essential addon: kube-proxy...
...
```

---

## Kubectl Get Nodes

* With the first controller set up, we look at *kubectl get nodes*.

* We see a single node in the *NotReady* state.

* *kubeadm init* does not configure a CNI network fabric. 

```
    sudo kubectl \
        --kubeconfig /etc/kubernetes/admin.conf \
        get nodes
```

---

## Installing Flannel

* There are many choices for CNI network fabrics meanwhile.

* Flannel is a simple and easy way to configure a layer 3 network fabric.

* A simple *kubectl apply* does the job and consumes its *yaml* from an URL.

```
    sudo kubectl \
        --kubeconfig /etc/kubernetes/admin.conf \
        apply -f https://github.com/coreos/flannel/raw/master/Documentation/kube-flannel.yml
```

---

## Kubectl Get Nodes

```
    sudo kubectl \
        --kubeconfig /etc/kubernetes/admin.conf \
        get nodes
```

---

## Kubectl Get Pods

* Several controller node components have been initialized as static pods.

* So, static pods live a bit outside the cluster and a bit within the cluster.

* Static Pods are controlled by the kubelet and run on the *containerd* runtime.

* These control plane components are themselves not controlled by control plane.

* The manifests of static pods are put into the */etc/kubernetes/manifests* folder.

```
sudo kubectl \
  --kubeconfig /etc/kubernetes/admin.conf \
  get pods \
  --all-namespaces
```

---

<!-- _class: invert -->

## Further Plans

* Extending the single controller node to a HA control plane with 3 controllers.

* Extending the control plane only configuration with an execution plane.

* And more ...